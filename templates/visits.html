<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Visits & Issues - Student Support Center</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
<div class="page">

  <!-- Header -->
  <header class="top-bar">
    <div class="logo-circle">SSC</div>
    <h1>Visits & Issues</h1>
  </header>

  <main class="content">

    <!-- Overview Card -->
    <div class="card hero">
      <h2>Counseling Visits</h2>
      <p>Track visits, issues, and whether any issues are critical.</p>
      <p style="margin-top: 0.5rem;">
        <a href="{{ url_for('new_visit') }}" class="button-link">+ Add Visit</a>
        <a href="{{ url_for('home') }}" class="button-link secondary">‚Üê Back to Dashboard</a>
      </p>

      <form method="get" action="{{ url_for('list_visits') }}" class="search-form">
        <!-- Student multi-select -->
        <label for="students">Students:</label>
        <select id="students" name="students" multiple>
          {% for s in all_students %}
            <option value="{{ s.student_id }}" {% if s.student_id|string in selected_students %}selected{% endif %}>{{ s.name }}</option>
          {% endfor %}
        </select>

        <!-- Mode -->
        <label for="mode">Mode:</label>
        <select id="mode" name="mode">
          <option value="" {% if not mode %}selected{% endif %}>Any</option>
          <option value="in-person" {% if mode=='in-person' %}selected{% endif %}>In-Person</option>
          <option value="virtual" {% if mode=='virtual' %}selected{% endif %}>Virtual</option>
        </select>

        <!-- Issue count -->
        <label for="issue_op"># Issues:</label>
        <select name="issue_op">
          <option value=">">></option>
          <option value="<"><</option>
          <option value="=">=</option>
        </select>
        <input type="number" name="issue_val" value="{{ issue_val }}" min="0">

        <!-- Critical -->
        <label for="critical">Critical:</label>
        <select id="critical" name="critical">
          <option value="" {% if not critical %}selected{% endif %}>Any</option>
          <option value="1" {% if critical=='1' %}selected{% endif %}>Critical</option>
          <option value="0" {% if critical=='0' %}selected{% endif %}>OK</option>
        </select>

        <button type="submit" class="button-link">Apply Filters</button>
      </form>
    </div>

    <!-- Table -->
    <div class="card">
      <table class="table">
        <thead>
          <tr>
            <th>Visit ID</th>
            <th>Student</th>
            <th>Date</th>
            <th>Mode</th>
            <th># Issues</th>
            <th>Critical?</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for v in visits %}
          <tr>
            <td>
              <a href="{{ url_for('visit_detail', visit_id=v.visit_id) }}">
                {{ v.visit_id }}
              </a>
            </td>
            <td>{{ v.student_name }}</td>
            <td>{{ v.date }}</td>
            <td style="text-transform: capitalize;">{{ v.mode }}</td>
            <td>{{ v.issue_count }}</td>
            <td>
              {% if v.has_critical_issue %}
                <span class="badge critical">Critical</span>
              {% else %}
                <span class="badge ok">OK</span>
              {% endif %}
            </td>
            <td>
              <form method="post"
                    action="{{ url_for('delete_visit', visit_id=v.visit_id) }}"
                    onsubmit="return confirm('Delete this visit?');"
                    style="display:inline;">
                <button type="submit" class="button-link secondary">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </main>

</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const studentSelect = document.getElementById('students');
    if (studentSelect) {
      new Choices(studentSelect, { removeItemButton: true, searchResultLimit: 10, placeholderValue: 'Select students' });
    }
  });
</script>
</body>
</html>
